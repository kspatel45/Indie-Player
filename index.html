<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indie Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --primary: #4169e1; --bg-dark: #0a0e12; }
        body { background-color: var(--bg-dark); color: #f0f6fc; font-family: sans-serif; overflow: hidden; }
        .glass-player { background: rgba(22, 27, 34, 0.98); border-top: 1px solid rgba(255,255,255,0.1); }
        .track-card { background: #161b22; transition: 0.2s; }
        .active-track { border: 2px solid var(--primary); background: rgba(65, 105, 225, 0.1); }
        .progress-bar { appearance: none; height: 4px; background: #30363d; width: 100%; border-radius: 2px; }
        .progress-bar::-webkit-slider-thumb { appearance: none; width: 12px; height: 12px; background: var(--primary); border-radius: 50%; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #30363d; }
    </style>
</head>
<body class="flex flex-col h-screen">

    <header class="p-4 border-b border-slate-800 bg-[#0d1117]">
        <div class="flex flex-col gap-3 max-w-6xl mx-auto">
            <h1 class="text-xl font-bold">Indie<span class="text-[#4169e1]">Player</span></h1>
            <div class="flex gap-2">
                <input type="text" id="searchInput" placeholder="Search songs..." class="flex-grow bg-[#161b22] border border-slate-700 rounded-full px-4 py-2 text-sm focus:outline-none focus:border-[#4169e1]">
                <button onclick="triggerSearch()" class="bg-[#4169e1] px-6 py-2 rounded-full text-sm font-bold">Search</button>
            </div>
        </div>
    </header>

    <main class="flex-grow overflow-y-auto custom-scrollbar p-4 pb-40">
        <div id="resultsGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
    </main>

    <footer class="fixed bottom-0 left-0 right-0 glass-player pb-6">
        <input type="range" id="progressBar" value="0" step="0.1" class="progress-bar" oninput="isSeeking=true" onchange="seekAudio()">
        <div class="flex items-center justify-between p-4 max-w-6xl mx-auto">
            <div class="flex items-center gap-3 w-1/3 overflow-hidden">
                <img id="playerCover" src="" class="w-12 h-12 rounded shadow-lg object-cover bg-slate-800">
                <div class="truncate">
                    <p id="playerTitle" class="text-sm font-bold truncate">Not Playing</p>
                    <p id="playerArtist" class="text-xs text-slate-400 truncate">Select a track</p>
                </div>
            </div>
            <div class="flex items-center gap-6">
                <button onclick="changeTrack(-1)"><i class="fas fa-step-backward text-xl"></i></button>
                <button id="masterPlayBtn" onclick="togglePlay()" class="w-12 h-12 bg-white text-black rounded-full flex items-center justify-center"><i class="fas fa-play ml-1"></i></button>
                <button onclick="changeTrack(1)"><i class="fas fa-step-forward text-xl"></i></button>
            </div>
            <div class="w-1/3 text-right">
                <span id="currentTime" class="text-xs font-mono">0:00</span>
            </div>
        </div>
    </footer>

    <audio id="mainAudio" crossorigin="anonymous"></audio>

    <script>
        const API_ENDPOINTS = ["https://saavn.dev/api", "https://saavn.me/api"];
        let currentApiIndex = 0;
        const audio = document.getElementById('mainAudio');
        let playlist = [], currentIndex = -1, isSeeking = false;

        window.onload = () => { triggerSearch("latest"); setupMediaSession(); };

        async function triggerSearch(query = document.getElementById('searchInput').value) {
            if (!query) return;
            resultsGrid.innerHTML = `<div class="col-span-full text-center py-20 text-slate-500">Searching...</div>`;
            
            for (let i = 0; i < API_ENDPOINTS.length; i++) {
                try {
                    const res = await fetch(`${API_ENDPOINTS[currentApiIndex]}/search/songs?query=${query}&limit=20`);
                    const data = await res.json();
                    if (data.data.results) {
                        playlist = data.data.results;
                        renderView();
                        return;
                    }
                } catch (e) {
                    currentApiIndex = (currentApiIndex + 1) % API_ENDPOINTS.length;
                }
            }
        }

        function renderView() {
            resultsGrid.innerHTML = playlist.map((s, i) => `
                <div onclick="playSong(${i})" class="track-card p-3 rounded-xl cursor-pointer ${currentIndex === i ? 'active-track' : ''}">
                    <img src="${s.image[2].url}" class="w-full aspect-square object-cover rounded-lg mb-2">
                    <p class="text-xs font-bold truncate">${s.name}</p>
                </div>
            `).join('');
        }

        async function playSong(index) {
            if (index < 0 || index >= playlist.length) return;
            currentIndex = index;
            const song = playlist[index];
            
            audio.src = song.downloadUrl[song.downloadUrl.length - 1].url;
            document.getElementById('playerTitle').textContent = song.name;
            document.getElementById('playerArtist').textContent = song.artists.primary[0].name;
            document.getElementById('playerCover').src = song.image[2].url;
            
            try {
                await audio.play();
                updateMediaSession(song);
            } catch (e) { console.error("Play blocked"); }
            renderView();
        }

        function togglePlay() { audio.paused ? audio.play() : audio.pause(); }
        function changeTrack(dir) { playSong(currentIndex + dir); }

        function setupMediaSession() {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.setActionHandler('play', () => audio.play());
                navigator.mediaSession.setActionHandler('pause', () => audio.pause());
                navigator.mediaSession.setActionHandler('previoustrack', () => changeTrack(-1));
                navigator.mediaSession.setActionHandler('nexttrack', () => changeTrack(1));
            }
        }

        function updateMediaSession(song) {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: song.name,
                    artist: song.artists.primary[0].name,
                    artwork: [{ src: song.image[2].url, sizes: '512x512', type: 'image/jpeg' }]
                });
                navigator.mediaSession.playbackState = 'playing';
            }
        }

        audio.onplay = () => { 
            document.getElementById('masterPlayBtn').innerHTML = `<i class="fas fa-pause"></i>`;
            if ('mediaSession' in navigator) navigator.mediaSession.playbackState = 'playing';
        };
        audio.onpause = () => { 
            document.getElementById('masterPlayBtn').innerHTML = `<i class="fas fa-play ml-1"></i>`;
            if ('mediaSession' in navigator) navigator.mediaSession.playbackState = 'paused';
        };
        audio.onended = () => changeTrack(1);
        audio.ontimeupdate = () => {
            if (isSeeking) return;
            document.getElementById('progressBar').value = (audio.currentTime / audio.duration) * 100 || 0;
            const m = Math.floor(audio.currentTime / 60);
            const s = Math.floor(audio.currentTime % 60);
            document.getElementById('currentTime').textContent = `${m}:${s.toString().padStart(2, '0')}`;
        };
        function seekAudio() { isSeeking = false; audio.currentTime = (document.getElementById('progressBar').value / 100) * audio.duration; }
    </script>
</body>
</html>
